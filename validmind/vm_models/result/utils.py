# Copyright Â© 2023-2024 ValidMind Inc. All rights reserved.
# See the LICENSE file in the root of this repository for details.
# SPDX-License-Identifier: AGPL-3.0 AND ValidMind Commercial

import os
from typing import TYPE_CHECKING, Dict, List, Union

from jinja2 import Template

from ... import api_client
from ...logging import get_logger
from ..figure import Figure
from ..html_renderer import StatefulHTMLRenderer

if TYPE_CHECKING:
    from .result import ResultTable


AI_REVISION_NAME = "Generated by ValidMind AI"
DEFAULT_REVISION_NAME = "Default Description"

logger = get_logger(__name__)

_result_template = None


def get_result_template():
    """Get the Jinja2 HTML template for rendering test results."""
    global _result_template

    if _result_template is None:
        with open(os.path.join(os.path.dirname(__file__), "result.jinja")) as f:
            _result_template = Template(f.read())

    return _result_template


async def update_metadata(content_id: str, text: str, _json: Union[Dict, List] = None):
    """Create or update a metadata object."""
    parts = content_id.split("::")
    content_id = parts[0]
    revision_name = parts[1] if len(parts) > 1 else None

    if revision_name:
        content_id = f"{content_id}::{revision_name}"

    logger.debug(f"Updating metadata for `{content_id}`")

    await api_client.alog_metadata(content_id, text, _json)


def tables_to_html(tables: List["ResultTable"]) -> str:
    """Convert a list of tables to HTML."""
    if not tables:
        return ""

    html_parts = ["<h3>Tables</h3>"]

    for table in tables:
        table_html = StatefulHTMLRenderer.render_table(
            data=table.data, title=table.title
        )
        html_parts.append(table_html)

    return "".join(html_parts)


def figures_to_html(figures: List[Figure]) -> str:
    """Convert a list of figures to HTML."""
    if not figures:
        return ""

    html_parts = ["<h3>Figures</h3>"]

    # Create a simple grid layout for multiple figures
    if len(figures) > 1:
        html_parts.append(
            '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">'
        )
        for figure in figures:
            html_parts.append(f"<div>{figure.to_html()}</div>")
        html_parts.append("</div>")
    else:
        html_parts.append(figures[0].to_html())

    return "".join(html_parts)
