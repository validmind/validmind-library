[tox]
envlist = 
    py{39,310,311,312}
    py{39,310,311,312}-min
    py{39,310,311,312}-max
    docs
    lint
isolated_build = true
skip_missing_interpreters = true

[testenv]
deps = 
    poetry
setenv =
    # Limit OpenMP on Mac to prevent segfaults
    OMP_NUM_THREADS = 1
    MKL_NUM_THREADS = 1
allowlist_externals = 
    poetry
    pip
commands_pre =
    python -m pip install --upgrade pip
    pip install poetry
    poetry config virtualenvs.create false
    poetry install --all-extras
commands =
    poetry run python -m unittest discover tests
    poetry run python -m unittest tests.test_unit_tests

[testenv:py{39,310,311,312}-min]
description = Test with minimum supported dependency versions
commands_pre =
    python -m pip install --upgrade pip
    pip install poetry
    poetry config virtualenvs.create false
    poetry install --all-extras
    # Install minimum versions of key dependencies
    pip install pandas==2.0.3 numpy==1.23.2 scikit-learn==1.1.0 matplotlib==3.5.0
    pip install transformers==4.32.0 torch==2.0.0 datasets==2.10.0 xgboost==1.5.2
    pip install nltk==3.8.1 plotly==5.0.0 scipy==1.9.0 statsmodels==0.13.0

[testenv:py{39,310,311,312}-max]
description = Test with latest dependency versions
commands_pre =
    python -m pip install --upgrade pip
    pip install poetry
    poetry config virtualenvs.create false
    poetry install --all-extras
    # Upgrade to latest versions of key dependencies
    pip install --upgrade pandas numpy scikit-learn matplotlib transformers
    pip install --upgrade torch datasets xgboost nltk plotly scipy statsmodels

[testenv:docs]
commands_pre =
    python -m pip install --upgrade pip
    pip install poetry
    poetry config virtualenvs.create false
    poetry install --all-extras
commands =
    poetry run make docs

[testenv:lint]
commands_pre =
    python -m pip install --upgrade pip
    pip install poetry  
    poetry config virtualenvs.create false
    poetry install --all-extras
commands =
    poetry run make lint
    poetry run make verify-copyright
    poetry run make verify-exposed-credentials

[testenv:freeze]
description = Test with a specific pip freeze file (specify via FREEZE_FILE env var)
allowlist_externals = 
    poetry
    pip
    bash
commands_pre =
    python -m pip install --upgrade pip
    pip install poetry
    poetry config virtualenvs.create false
    bash -c 'if [ -n "$FREEZE_FILE" ] && [ -f "$FREEZE_FILE" ]; then pip install -r "$FREEZE_FILE"; else echo "Set FREEZE_FILE env var to pip freeze file path"; exit 1; fi'
    poetry install --no-deps
commands =
    poetry run python -m unittest discover tests -v 