{%- set builtin_types = ['str', 'dict', 'list', 'bool', 'int', 'float', 'object', 'callable', 'tuple', 'type', 'None'] -%}
{%- set type_keywords = ['Any', 'Union', 'Dict', 'List', 'Optional', 'Callable', 'Tuple'] -%}

{% macro format_type(type, module=None, add_links=false) %}
<!-- types.jinja2 - format_type -->
{%- if type is string -%}
  {%- if type.startswith('{') and type.endswith('}') -%}
    {{ format_type(type|fromjson, module, add_links) }}
  {%- elif type.startswith("'") or type.startswith('"') -%}
    <span class="s">{{ type }}</span>
  {%- elif type in type_keywords -%}
    <span class="n">{{ type }}</span>
  {%- elif type|lower in builtin_types -%}
    <span class="nb">{{ type }}</span>
  {%- else -%}
    <span class="n">{{ type }}</span>
  {%- endif -%}
{%- elif type is mapping -%}
  {%- if type.cls is defined -%}
    {%- if type.cls == "ExprAttribute" and type.values is sequence -%}
      {%- for value in type.values -%}
        {{ format_type(value, module, add_links) }}
        {%- if not loop.last -%}.<span class="p"></span>{%- endif -%}
      {%- endfor -%}
    {%- elif type.cls == "ExprName" -%}
      {%- if module and type.name in module.members and module.members[type.name].kind == "alias" -%}
        {{ module.members[type.name].target_path }}
      {%- elif type.name in type_keywords -%}
        <span class="n">{{ type.name }}</span>
      {%- elif type.name|lower in builtin_types -%}
        <span class="nb">{{ type.name }}</span>
      {%- elif add_links and type.name not in type_keywords -%}
        <a href="/reference/validmind/vm_models.html#class-{{ type.name|lower }}">validmind.vm_models.{{ type.name }}</a>
      {%- else -%}
        <span class="n">{{ type.name }}</span>
      {%- endif -%}
    {%- elif type.cls == "ExprList" -%}
      <span class="p">[</span>
      {%- for elem in type.elements -%}
        {{ format_type(elem, module, add_links) }}
        {%- if not loop.last -%}<span class="p">, </span>{%- endif -%}
      {%- endfor -%}
      <span class="p">]</span>
    {%- elif type.cls == "ExprSet" -%}
      <span class="p">{</span>
      {%- for elem in type.elements -%}
        {{ format_type(elem, module, add_links) }}
        {%- if not loop.last -%}<span class="p">, </span>{%- endif -%}
      {%- endfor -%}
      <span class="p">}</span>
    {%- elif type.cls == "ExprSubscript" -%}
      {{ format_type(type.left, module, add_links) }}<span class="p">[</span>
      {%- if type.slice.cls == "ExprTuple" -%}
        {%- for elem in type.slice.elements -%}
          {%- if elem.cls == "ExprSubscript" and elem.left.cls == "ExprName" and elem.left.name == "Callable" -%}
            <span class="p">[</span>
            {%- for arg in elem.slice.elements[0].elements -%}
              {{ format_type(arg, module, add_links) }}
              {%- if not loop.last -%}<span class="p">, </span>{%- endif -%}
            {%- endfor -%}
            <span class="p">], </span>{{ format_type(elem.slice.elements[1], module, add_links) }}
          {%- else -%}
            {{ format_type(elem, module, add_links) }}
          {%- endif -%}
          {%- if not loop.last -%}<span class="p">, </span>{%- endif -%}
        {%- endfor -%}
      {%- else -%}
        {{ format_type(type.slice, module, add_links) }}
      {%- endif -%}
      <span class="p">]</span>
    {%- elif type.cls == "ExprCall" -%}
      {{ format_type(type.func, module, add_links) }}<span class="p">(</span>
      {%- for arg in type.args -%}
        {{ format_type(arg, module, add_links) }}
        {%- if not loop.last -%}<span class="p">, </span>{%- endif -%}
      {%- endfor -%}
      <span class="p">)</span>
    {%- elif type.cls == "ExprBinOp" -%}
      {{ format_type(type.left, module, add_links) }}<span class="p">{{ type.op }}</span>{{ format_type(type.right, module, add_links) }}
    {%- elif type.cls == "ExprDecorator" -%}
      @{{ format_type(type.value, module, add_links) }}
    {%- elif type.cls == "ExprInit" -%}
      <span class="kw">def</span> <span class="name">__init__</span>(<span class="params">
      {%- for param in type.params -%}
        {{ format_type(param, module, add_links) }}
        {%- if not loop.last -%}, {% endif -%}
      {%- endfor -%}
      </span>):
    {%- else -%}
      {{ format_type(type|string, module, add_links) }}
    {%- endif -%}
  {%- elif type.kind is defined -%}
    {%- if type.kind == "union" -%}
      <span class="n">Union</span><span class="p">[</span>
      {%- for t in type.types -%}
        {{ format_type(t, module, add_links) }}
        {%- if not loop.last -%}<span class="p">, </span>{%- endif -%}
      {%- endfor -%}
      <span class="p">]</span>
    {%- elif type.kind == "generic" -%}
      <span class="n">{{ type.base }}</span><span class="p">[</span>
      {%- for arg in type.args -%}
        {{ format_type(arg, module, add_links) }}
        {%- if not loop.last -%}<span class="p">, </span>{%- endif -%}
      {%- endfor -%}
      <span class="p">]</span>
    {%- endif -%}
  {%- else -%}
    {{ format_type(type|string, module, add_links) }}
  {%- endif -%}
{%- else -%}
  {{ format_type(type|string, module, add_links) }}
{%- endif -%}
{% endmacro %}

{%- macro format_return_type(returns) -%}
<!-- types.jinja2 - format_return_type -->
{%- if returns.cls == "ExprName" -%}
    {%- if returns.name in validmind.members.client.members and validmind.members.client.members[returns.name].kind == "alias" -%}
        {{ validmind.members.client.members[returns.name].target_path }}
    {%- else -%}
        {{ returns.name }}
    {%- endif -%}
{%- elif returns.cls == "ExprSubscript" and returns.left is defined -%}
    {{ returns.left.name }}[
    {%- if returns.slice.cls == "ExprTuple" -%}
        {{ returns.slice.elements|map(attribute="name")|join(", ") }}
    {%- else -%}
        {{ returns.slice.name }}
    {%- endif -%}
    ]
{%- else -%}
    {{ returns|string }}
{%- endif -%}
{%- endmacro %}

{%- macro format_module_return_type(returns, module, full_data) -%}
<!-- types.jinja2 - format_module_return_type -->
{%- if returns.cls == "ExprName" -%}
    {%- if returns.name in module.members and module.members[returns.name].kind == "alias" -%}
        {{ module.members[returns.name].target_path }}
    {%- else -%}
        {{ returns.name }}
    {%- endif -%}
{%- elif returns.cls == "ExprSubscript" and returns.left is defined -%}
    {{ returns.left.name }}[
    {%- if returns.slice.cls == "ExprTuple" -%}
        {{ returns.slice.elements|map(attribute="name")|join(", ") }}
    {%- else -%}
        {{ returns.slice.name }}
    {%- endif -%}
    ]
{%- else -%}
    {{ returns|string }}
{%- endif -%}
{%- endmacro %}