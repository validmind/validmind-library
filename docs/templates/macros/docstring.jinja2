{% macro format_docstring(docstring) %}
{% if docstring is mapping %}
    {%- if docstring.parsed is defined and docstring.parsed is not none -%}
        {# Try to use docstring-parser output #}
        {%- set sections = [] -%}
        
        {# Main description #}
        {%- if docstring.parsed.short_description -%}
            {%- set _ = sections.append(docstring.parsed.short_description) -%}
        {%- endif -%}
        {%- if docstring.parsed.long_description -%}
            {%- set _ = sections.append(docstring.parsed.long_description) -%}
        {%- endif -%}
        
        {# Parameters #}
        {%- if docstring.parsed.params -%}
            {%- set _ = sections.append("**Parameters**\n") -%}
            {%- for param in docstring.parsed.params -%}
                {%- set _ = sections.append("- **" ~ param.arg_name ~ "**: " ~ param.description) -%}
            {%- endfor -%}
        {%- endif -%}
        
        {# Returns #}
        {%- if docstring.parsed.returns -%}
            {%- set _ = sections.append("**Returns**\n") -%}
            {%- set _ = sections.append("- " ~ docstring.parsed.returns.description) -%}
        {%- endif -%}
        
        {# Raises #}
        {%- if docstring.parsed.raises -%}
            {%- set _ = sections.append("**Raises**\n") -%}
            {%- for raises in docstring.parsed.raises -%}
                {%- set _ = sections.append("- **" ~ raises.type_name ~ "**: " ~ raises.description) -%}
            {%- endfor -%}
        {%- endif -%}
        
        {# If we got any sections, join them, otherwise fall back to value #}
        {%- if sections -%}
            {{ sections | join('\n\n') }}
        {%- else -%}
            {{ docstring.value }}
        {%- endif -%}
    {%- else -%}
        {# Always fall back to value if no parsed content #}
        {{ docstring.value }}
    {%- endif -%}
{% else %}
{{ docstring }}
{% endif %}
{% endmacro %} 