{% macro format_docstring(docstring) %}
<!-- docstring.jinja2 -->
{% if docstring is mapping %}
    {%- if docstring.parsed is defined and docstring.parsed is not none -%}
        {# Try to use docstring-parser output #}
        {%- set sections = [] -%}
        
        {# Main description #}
        {%- if docstring.parsed.short_description -%}
            {%- set _ = sections.append(docstring.parsed.short_description) -%}
        {%- endif -%}
        {%- if docstring.parsed.long_description -%}
            {%- set _ = sections.append(docstring.parsed.long_description) -%}
        {%- endif -%}
        
        {# Parameters #}
        {%- if docstring.parsed.params -%}
            {%- set _ = sections.append("\n**Parameters**") -%}
            {%- for param in docstring.parsed.params -%}
                {%- if param.arg_name and param.description -%}
                    {%- set desc = param.description | trim -%}
                    {%- if desc.endswith(')') and '(default:' in desc -%}
                        {%- set desc = desc[:-1] ~ ')' -%}
                    {%- endif -%}
        
                    {# Check if the parameter has a type annotation #}
                    {%- if param.type_name -%}
                        {%- set is_optional = param.value == "None" -%}
                        {%- set type_info = '(' ~ param.type_name ~ (', optional' if is_optional else '') ~ ')' -%}
                        {%- set _ = sections.append("- **" ~ param.arg_name ~ "** " ~ type_info ~ ": " ~ desc) -%}
                    {%- else -%}
                        {%- set _ = sections.append("- **" ~ param.arg_name ~ "**: " ~ desc) -%}
                    {%- endif -%}
                {%- endif -%}
            {%- endfor -%}
        {%- endif -%}

        {# Returns #}
        {%- if docstring.parsed.returns -%}
            {%- set _ = sections.append("\n**Returns**") -%}
            {%- if docstring.parsed.returns.description -%}
                {%- set _ = sections.append("- " ~ docstring.parsed.returns.description | trim) -%}
            {%- endif -%}
        {%- endif -%}
        
        {# Raises #}
        {%- if docstring.parsed.raises -%}
            {%- set _ = sections.append("\n**Raises**") -%}
            {%- for raises in docstring.parsed.raises -%}
                {%- if raises.type_name and raises.description -%}
                    {%- set _ = sections.append("- **" ~ raises.type_name ~ "**: " ~ raises.description | trim) -%}
                {%- endif -%}
            {%- endfor -%}
        {%- endif -%}
        
        {# Join sections with proper spacing #}
        {%- if sections -%}
            {{ sections | join('\n') | trim }}
        {%- else -%}
            {{ docstring.value | trim }}
        {%- endif -%}
    {%- else -%}
        {# Always fall back to value if no parsed content #}
        {{ docstring.value | trim }}
    {%- endif -%}
{% else %}
{{ docstring | trim }}
{% endif %}
{% endmacro %} 